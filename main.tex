\documentclass[twocolumn]{scrartcl}

% Step environment
% <https://tex.stackexchange.com/a/12943/13262>
\usepackage{amsthm}
\newtheorem*{theorem}{Step}
\newtheoremstyle{named}{}{}{\itshape}{}{\bfseries}{.}{.5em}{\thmnote{#1 }#3}
\theoremstyle{named}
\newtheorem*{step}{Step}

\usepackage{microtype}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{booktabs}
\usepackage{tabularx}

\usepackage{pgfplots}

% <https://tex.stackexchange.com/a/43009/13262>
\DeclarePairedDelimiter\abs{\lvert}{\rvert}%

\usepackage[T1]{fontenc}
\usepackage{newtxtext}
\usepackage{newtxmath}

% degree symbol
\usepackage{gensymb}

% <https://tex.stackexchange.com/a/413899/13262>
\usepackage{etoolbox}
\makeatletter
\long\def\etb@listitem#1#2{%
  \expandafter\ifblank\expandafter{\@gobble#2}
    {}
    {\expandafter\etb@listitem@i
     \expandafter{\@secondoftwo#2}{#1}}}
\long\def\etb@listitem@i#1#2{#2{#1}}
\makeatother
\usepackage[sorting=none]{biblatex}
\bibliography{bib}

\usepackage{amsmath}
\DeclareMathOperator{\sign}{sign}

\usepackage{bm}
\newcommand\rgb{\bm{R}}

\title{Some notes on the CIECAM02 and CAM16 color models}
\author{Nico Schlömer}

\begin{document}

\maketitle
\begin{abstract}
  This note is concerned with the CIECAM02 color appearence model and its
  successor, the CAM16 color appearence model. Several flaws are
  pointed out and remedies are suggested. The resulting color model is algebraically
  equivalent to CIECAM02/CAM16, but shorter, more efficient, and does not
  contain edge-case breakdowns.
\end{abstract}

\section{Introduction}

The CIECAM02 color appearance model~\cite{ciecam02} has attracted much
attention and was generally thought of as a successor to the ever so popular
CIELAB color model. However, it was quickly discovered that CIECAM02 breaks
down for certain input values. A fair number of research articles suggests
fixes for this behavior, most of them by modifying the first three steps of the
forward model. Luo and Li themselves give an overview of the suggested
improvements~\cite{ciecam02-recent}; see references therein.  Most recently,
again Li and Luo~\cite{cam16} gave their own suggestion on how to best
circumvent the breakdown~\cite{cam16}. The updated algorithm differs from the
original CIECAM02 only in the first three steps of the foward model.

While focusing on the first three steps, it appears that that the rest of the
algorithm has not received much attention over the years. In both CIECAM02 and
its updated version CAM16, there are some flaws that make the description of
the algorithm more complicated than necessary, and in edge cases lead to break
downs once again. The present document describes those flaws and suggests
improvements (Section~\ref{sec:ff}). The resulting model description
(Section~\ref{sec:full}) is entirely equivalent to the CIECAM02/CAM16, but is
simpler -- and hence faster and easier to implement -- and works in all edge
cases.


\section{Flaws and fixes}\label{sec:ff}

This section gives the flaws of CIECAM02/CAM16, listed by their steps numbered
as in CAM16. All steps also appear in the CIECAM02 color appearence model, so
all flaws and fixes are equally applicable there.

\subsection{Step 3, forward model}

Step 3 of the forward model reads

\begin{step}[3]
Calculate the postadaptation cone response
(resulting in dynamic range compression).
\[
  R_a = 400 \left(\frac{\left(\frac{F_L R_c}{100}\right)^{0.42}}{\left(\frac{F_L R_c}{100}\right)^{0.42} + 27.13}\right) + 0.1
\]
If $R_c$ is negative, then
\[
  R_a = -400 \left(\frac{\left(\frac{-F_L R_c}{100}\right)^{0.42}}{\left(\frac{-F_L R_c}{100}\right)^{0.42} + 27.13}\right) + 0.1
\]
and similarly for the computations of $G_a$ and $B_a$.
\end{step}

If the $\sign$ operator is used here as it is used later in step 5 of the
backward model, the above description can be shortened.

Furthermore, the term $0.1$ is added here, but in all of the following steps in
which $R_a$ is used -- except the computation of $t$ in step 9 --, it cancels
out algebraically.  Unfortunately, said cancellation is not always exact when
computed in floating point arithmetic. Luckily, the adverse effect of such
rounding errors is rather limited here. The results will only be distorted for
very small input values, e.g., $X=Y=Z=0$; see Table~\ref{tab:zero} For matters
of simplification, it is still suggested to include the term $0.1$ only in
the computation of $t$ in step 9.

\subsection{Step 9, forward model}

The saturation is currently computed as
\begin{step}[9]
  Calculate the correlates of [\dots] saturation ($s$).
  \[
    s \coloneqq 100 \sqrt{M/Q}.
  \]
\end{step}
This expression is not well-defined if $Q=0$, a value only occuring if the
input values are $X=Y=Z=0$. When making use of the definition of $M$ and $Q$,
one gets to an expression for $s$ that is well-defined in \emph{all} cases:
\begin{align}
  \label{eq:alpha}
  \alpha&\coloneqq t^{0.9} {(1.64-0.29^n)}^{0.73},\\
  \nonumber
  s &\coloneqq 50 \sqrt{\frac{c\alpha}{A_w + 4}}.
\end{align}


\subsection{Steps 2 and 3, backward model}

\begin{step}[2]
Calculate $t$, $e_t$, $p_1$, $p_2$, and $p_3$.
\begin{align*}
  t &= {\left(\frac{C}{\sqrt{\frac{J}{100}} {(1.64 - 0.29^n)}^{0.73}}\right)}^\frac{1}{0.9},\\
  e_t &= \frac{1}{4} \left[\cos(h'\pi/180\degree + 2) + 3.8\right],\\
  p_1 &= \frac{50000}{13} N_c N_{cb} e_t \frac{1}{t},\\
  p_2 &= \frac{A}{N_{bb}} + 0.305,\\
  p_3 &= \frac{21}{20}.
\end{align*}
\end{step}

\begin{step}[3]
Calculate $a$ and $b$.
If $t=0$, then $a=b=0$ and go to Step 4.
In next computations be transform $h$ from degrees to radians
before calculating $\sin(h)$ and $\cos(h)$:
If $\abs{\sin(h)} \ge \abs{\cos(h)}$ then
\begin{align*}
  p_4 &= \frac{p_1}{\sin(h)},\\
  b &= \frac{p_2 (2+p_3) \frac{460}{1403}}{p_4 + (2+p_3) \frac{220}{1403} \frac{\cos(h)}{\sin(h)} - \frac{27}{1403} + p_3 \frac{6300}{1403}},\\
  a &= b \frac{\cos(h)}{\sin(h)}.
\end{align*}
If $\abs{\cos(h)} > \abs{\sin(h)}$ then
\begin{align*}
  p_5 &= \frac{p_1}{\cos(h)},\\
  a &= \frac{p_2 (2+p_3) \frac{460}{1403}}{%
    p_5
    + (2+p_3) \frac{220}{1403} -
    \left(\frac{27}{1403}  - p_3 \frac{6300}{1403}\right) \frac{\sin(h)}{\cos(h)}
  },\\
  b &= a \frac{\sin(h)}{\cos(h)}.
\end{align*}
\end{step}

Some of the complications in this step stem from the fact that the variable $t$
might be $0$ in the denominator of $p_1$. Likewise, the distinction of cases in $\sin(h)$ and $\cos(h)$ is necessary
to avoid division by $0$ in $a$ and $b$.

It turns out that both of these problems can be avoided more elegantly.
Consider, in the case $\abs{\sin(h)} \ge \abs{\cos(h)}$:
\begin{align*}
  p'_1 &\coloneqq \frac{50000}{13} N_c N_{cb} e_t,\\
  b &= \frac{p_2 (2+p_3) \frac{460}{1403}}{\frac{p'_1}{t\sin(h)} + (2+p_3) \frac{220}{1403} \frac{\cos(h)}{\sin(h)} - \frac{27}{1403} + p_3 \frac{6300}{1403}}\\
   &= \frac{t \sin(h) p_2 (2+p_3) \frac{460}{1403}}{p'_1 + t (2+p_3) \frac{220}{1403} \cos(h) + t \sin(h) \frac{6588}{1403}}\\
   &= \frac{23 t \sin(h) p_2}{23 p'_1 + 11 t \cos(h) + 108 t \sin(h)},
\end{align*}
and
\[
  a = \frac{23 t \cos(h) p_2}{23 p'_1 + 11 t \cos(h) + 108 t \sin(h)}.
\]
Conveniently, the exact same expressions are retrieved in the case
$\abs{\cos(h)} > \abs{\sin(h)}$. Those expressions are always well-defined since
\begin{multline*}
  23 p'_1 + 11 t \cos(h) + 108 t \sin(h)\\
  = \frac{23 p'_1 p_2}{R'_a + G'_a + \tfrac{21}{20}B'_a + 0.305}
  \neq 0.
\end{multline*}

In the algorithm, the value of $t$ can be retrieved via
$\alpha$~\eqref{eq:alpha} from the input variables. Indeed, if the saturation
correlate $s$ is given, one has
\[
  \alpha \coloneqq {\left(\frac{s}{50}\right)}^2 \frac{A_w+4}{c};
\]
if $M$ is given, one can compute $C\coloneqq M / F_L^{0.25}$ and then
\[
\alpha\coloneqq\begin{dcases*}
  0 &if $J=0$,\\
  \frac{C}{\sqrt{J/100}}&otherwise.
\end{dcases*}
\]
It is mildly unfortunate that one has to introduce a case distinction for
$J=0$ here, but this is an operations that can still be performed at reasonable
efficiency.


\section{Full model\label{sec:full}}

All steps that differ from the original model are marked with an asterisk (*).

As an abbreviation, the bold $\rgb$ is used whenever the equation applied
to $R$, $G$, and $B$ alike.

\subsection{Forward model}

\begin{step}[0*]
Calculate all values/parameters which are independent
of the input sample.
\begin{align*}
  &\begin{pmatrix}R_w\\G_w\\B_w\end{pmatrix}
    = M_{16}
  \begin{pmatrix}X_w\\Y_w\\Z_w\end{pmatrix},\\
  &D = F \left[1 - \tfrac{1}{3.6} \exp\left(\tfrac{-L_a-42}{92}\right)\right].
\end{align*}
If $D$ is greater than one or less than zero, set it to one or zero,
respectively.
\begin{align*}
  &D_{\rgb} = D\frac{Y_W}{\rgb_W} -1 + D,\\
  &k = \frac{1}{5L_A + 1},\\
  &F_L = k^4 L_A + 0.1 {(1-k^4)}^2 {(5L_A)}^{1/3},\\
  &n = \frac{Y_b}{Y_W},\\
  &z = 1.58 + \sqrt{n},\\
  &N_{bb} = \frac{0.725}{n^{0.2}},\\
  &N_{cb} = N_{bb},\\
  &\rgb_{wc} = D_{\rgb} \rgb_w,\\
  &\rgb_{aw} = 400
  \frac
  {{\left(\frac{F_L \rgb_{wc}}{100}\right)}^{0.42}}
  {{\left(\frac{F_L \rgb_{wc}}{100}\right)}^{0.42} + 27.13},\\
  &A_w = \left(2R_{aw} + G_{aw} + \tfrac{1}{20} B_{aw}\right) \cdot N_{bb}.
\end{align*}
\end{step}

\begin{table}\centering
  \begin{tabularx}{\linewidth}{XXXX}
  \toprule
          & $F$ & $c$   & $N_c$\\
  \midrule
  Average & 1.0 & 0.69  & 1.0\\
  Dim     & 0.9 & 0.59  & 0.9\\
  Dark    & 0.8 & 0.525 & 0.8\\
  \bottomrule
\end{tabularx}
\caption{Surround parameters.}
\end{table}


\begin{table}\centering
  \begin{tabularx}{\linewidth}{XXXXXX}
  \toprule
        & Red   & Yellow & Green & Blue   & Red\\
  \midrule
  $i$   & 1     & 2     & 3      & 4      & 5\\
  $h_i$ & 20.14 & 90.00 & 164.25 & 237.53 & 380.14\\
  $e_i$ & 0.8   & 0.7   & 1.0    & 1.2    & 0.8\\
  $H_i$ & 0.0   & 100.0 & 200.0  & 300.0  & 400.0\\
  \bottomrule
\end{tabularx}
  \caption{Unique hue data for calculation of hue quadrature.}\label{table:hue}
\end{table}

\begin{step}[1]
Calculate `cone' responses.
\[
\begin{pmatrix}R\\G\\B\end{pmatrix}
= M_{16} \begin{pmatrix}X\\Y\\Z\end{pmatrix}
\]
\end{step}

\begin{step}[2]
Complete the color adaptation of the illuminant in
the corresponding cone response space (considering various
luminance levels and surround conditions included in $D$, and
hence in $D_R$, $D_G$, and $D_B$).
\[
  \rgb_c = D_{\rgb} \cdot \rgb
\]
\end{step}

\begin{step}[3*]
Calculate the modified postadaptation cone response
(resulting in dynamic range compression).
\[
  \rgb'_a = 400 \sign(\rgb_c)
    \frac
    {{\left(\frac{F_L \abs{\rgb_c}}{100}\right)}^{0.42}}
    {{\left(\frac{F_L \abs{\rgb_c}}{100}\right)}^{0.42} + 27.13}.
\]
\end{step}

\begin{step}[4]
Calculate Redness--Greenness ($a$), Yellowness--Blueness ($b$) components,
and hue angle ($h$):
\begin{align*}
  a&\coloneqq R'_a - \tfrac{12}{11} G'_a + \tfrac{1}{11} B'_a\\
  b&\coloneqq \tfrac{1}{9} R'_a + \tfrac{1}{9} G'_a - \tfrac{2}{9} B'_a\\
  h&\coloneqq \arctan(b/a).
\end{align*}
(Make sure that $h$ is between $0\degree$ and $360\degree$.)
\end{step}

\begin{step}[5]
Calculate eccentricity [$e_t$, hue quadrature composition
($H$) and hue composition ($H_c$)].

Using the following unique hue data in table~\ref{table:hue}, set
$h'= h + 360\degree$ if $h < h_1$, otherwise $h'=h$.
Choose a proper $i\in\{1,2,3,4\}$ so that $h_i\le h' < h_{i+1}$.
Calculate
\[
  e_t = \tfrac{1}{4}
  \left[
    \cos(h'\pi/180\degree + 2) + 3.8
  \right]
\]
which is close to, but not exactly the same as, the eccentricity factor given
in table~\ref{table:hue}.

Hue quadrature is computed using the formula
\[
  H = H_i + \frac{100 e_{i+1} (h'-h_i)}{e_{i+1}(h'-h_i) + e_i (h_{i+1}-h')}
\]
and hue composition $H_c$ is computed according to $H$.  If $i=3$ and $H =
241.2116$ for example, then $H$ is between $H_3$ and $H_4$ (see
table~\ref{table:hue} above). Compute $P_L=H_4-H = 58.7884$; $P_R = H – H_3 =
41.2116$ and round $P_L$ and $P_R$ values to integers $59$ and $41$. Thus,
according to table~\ref{table:hue}, this sample is considered as having 59\%
of green and 41\% of blue, which is the $H$c and can be reported as 59G41B or
41B59G.
\end{step}

\begin{step}[6*]
Calculate achromatic response $A$
\[
  A\coloneqq (2 R'_a + G'_a + \tfrac{1}{20} B'_a) \cdot N_{bb}
  \]
\end{step}

\begin{step}[7]
Calculate the correlate of lightness $J$
\[
  J \coloneqq 100 {(A / A_w)}^{cz}
  \]
\end{step}

\begin{step}[8]
  Calculate the correlate of brightness $Q$
  \[
    Q \coloneqq \frac{4}{c} \sqrt{\frac{J}{100}} (A_w+4) F_L^{0.25}
    \]
\end{step}

\begin{step}[9*]
Calculate the correlates of chroma ($C$), colorfulness ($M$), and saturation
  ($s$).
\begin{align*}
  t&\coloneqq \frac{50000/13 N_c N_{cb} e_t \sqrt{a^2 + b^2}}{R'_a + G'_a + 21/20 B'_a + 0.305},\\
  \alpha&\coloneqq t^{0.9} \cdot {(1.64 - 0.29^n)}^{0.73},\\
  C&\coloneqq \alpha \sqrt{\frac{J}{100}},\\
  M&\coloneqq C\cdot F_L^{0.25},\\
  s &\coloneqq 50 \sqrt{\frac{\alpha c}{A_w + 4}}.
\end{align*}
\end{step}

\subsection{Backward model}

\begin{step}[1]
  Obtain $J$, $C$; and $h$ from $H$, $Q$, $M$, $s$.

  The input data can be different combinations of perceived correlates, that
  is, $J$ or $Q$; $C$, $M$, or $s$; and $H$ or $h$. Hence the following
  sub-steps are needed to convert the input parameters to the parameters $J$,
  $C$, and $h$.
\end{step}

\begin{step}[1--1]
Compute $J$ from $Q$ (if input is $Q$)
\[
  J\coloneqq 6.25 \left(\frac{cQ}{(A_w+4) F_L^{0.25}}\right).
\]
\end{step}

\begin{step}[1--2*]
Calculate $t$ from $C$, $M$, or $s$.
\begin{itemize}
  \item If input is $C$ or $M$:
    \begin{align*}
      C &\coloneqq M / F_L^{0.25} \:\text{if input is $M$}\\
      \alpha &\coloneqq \begin{dcases*}
          0 &if $J=0$,\\
          \frac{C}{\sqrt{J/100}}& otherwise.
      \end{dcases*}
    \end{align*}
  \item If input is $s$:
    \[
    \alpha \coloneqq {\left(\frac{s}{50}\right)}^2 \frac{A_w+4}{c}
    \]
\end{itemize}
Compute $t$ from $\alpha$:
\[
  t \coloneqq {\left(\frac{\alpha}{{(1.64 - 0.29^n)}^{0.73}}\right)}^{1/0.9}
\]
\end{step}

\begin{step}[1--3]
Calculate $h$ from $H$ (if input is $H$).
The correlate of hue ($h$) can be computed by using data in
table~\ref{table:hue} in the forward model.
Choose a proper $i\in\{1,2,3,4\}$ such that
$H_i \le H < H_{i+1}$. Then
\[
  h' = \frac{(H-H_i)(e_{i+1}h_i - e_i h_{i+1}) - 100 h_i e_{i+1}}{(H-H_i)(e_{i+1}-e_i) - 100 e_{i+1}}.
\]
Set $h = h' - 360\degree$ if $h' > 360\degree$, and $h=h'$ otherwise.
\end{step}

\begin{step}[2*]
Calculate $e_t$, $A$, $p'_1$, and $p'_2$
\begin{align*}
  e_t &= \tfrac{1}{4} (\cos(h\pi/180\degree + 2) + 3.8),\\
  A &= A_w  {(J/100)}^{1/(cz)},\\
  p'_1 &= e_t \tfrac{50000}{13} N_c N_{cb},\\
  p'_2 &= A / N_{bb}.
\end{align*}
\end{step}

\begin{step}[3*]
Calculate $a$ and $b$
  \begin{align*}
    \gamma &\coloneqq \frac{23 (p'_2+0.305) t}{23 p'_1 + 11 t \cos(h) + 108 t \sin(h)},\\
    a &\coloneqq \gamma \cos(h),\\
    b &\coloneqq \gamma \sin(h).
  \end{align*}
\end{step}

\begin{step}[4]
  Calculate $R'_a$, $G'_a$, and $B'_a$.
  \begin{align*}
    R'_a &= (460 p'_2 + 451 a + 288 b) / 1403,\\
    G'_a &= (460 p'_2 - 891 a - 261 b) / 1403,\\
    B'_a &= (460 p'_2 - 220 a - 6300 b) / 1403.
  \end{align*}%
\end{step}

\begin{step}[5*]
Calculate $R_c$, $G_c$, and $B_c$,
  \[
  \rgb_c = \sign(\rgb'_a)
  \frac{100}{F_L} {\left(
    \frac{27.13 \abs{\rgb'_a}}{400 - \abs{\rgb'_a}}
    \right)}^{1/0.42}.
  \]
\end{step}

\begin{step}[6]
Calculate $R$, $G$, and $B$ from $R_c$, $G_c$, and $B_c$.
\[
  \rgb = \rgb_c / D_{\rgb}.
\]
\end{step}

\begin{step}[7]
Calculate $X$, $Y$, and $Z$ (for the coefficients of the inverse matrix, see
the note at the end of the appendix B).  % TODO
\[
\begin{pmatrix}X\\Y\\Z\end{pmatrix}
  = M_{16}^{-1}
\begin{pmatrix}R\\G\\B\end{pmatrix}.
\]
\end{step}

\begin{table}\centering
  \begin{tabularx}{\linewidth}{XXX}
  \toprule
          & colorio & colour~\cite{colour0310}\\
  \midrule
    $J$ & \texttt{0.0} & \texttt{3.258e-22}\\
    $C$ & \texttt{0.0} & \texttt{6.222e-24}\\
    $h$ & \texttt{0.0} & \texttt{180.0}\\
    $Q$ & \texttt{0.0} & \texttt{2.233e-10}\\
    $M$ & \texttt{0.0} & \texttt{4.4986e-24}\\
    $s$ & \texttt{0.0} & \texttt{1.4192e-05}\\
  \bottomrule
\end{tabularx}
\caption{CIECAM02 values upon input $X=Y=Z=0$ for different implementations.
  The exact solutions are zeros for every entry.}\label{tab:zero}
\end{table}

\begin{figure}
\input{perf.tex}
  \caption{Performance comparison of the conversion from CIECAM02 to XYZ (using
  $J$, $C$, and $h$). Making use of the suggested improvments in the backwards model,
  colorio is about 30\% faster.}
\end{figure}

\printbibliography{}

\end{document}
